<% layout('/layouts/boilerplate') -%>

<div class="dashboard-container">
    <%- include('../partials/dashboard-sidebar') %>

    <div class="dashboard-main">
        <div class="settings-container">
            <h2>Profile Settings</h2>

            <form action="/dashboard/settings" method="POST" enctype="multipart/form-data">
                <!-- Profile Image Section -->
                <div class="settings-section">
                    <h3>Profile Image</h3>
                    <div class="profile-image-upload">
                        <div class="current-image">
                            <img src="<%= user.profileImage %>" alt="Profile" id="profile-preview">
                        </div>
                        <div class="upload-controls">
                            <input type="file" 
                                   name="profileImage" 
                                   id="profile-upload"
                                   accept="image/*"
                                   class="hidden">
                            <label for="profile-upload" class="btn btn-outline-primary">
                                <i class="fas fa-camera"></i> Change Photo
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Basic Information -->
                <div class="settings-section">
                    <h3>Basic Information</h3>
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" 
                               id="username" 
                               name="username" 
                               value="<%= user.username %>"
                               class="form-control"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" 
                               id="email" 
                               name="email" 
                               value="<%= user.email %>"
                               class="form-control"
                               required>
                    </div>
                </div>

                <!-- Notification Preferences -->
                <div class="settings-section">
                    <h3>Notification Preferences</h3>
                    <div class="form-check">
                        <input type="checkbox" 
                               id="emailNotifications" 
                               name="emailNotifications"
                               class="form-check-input"
                               <%= user.notifications?.email ? 'checked' : '' %>>
                        <label class="form-check-label" for="emailNotifications">
                            Email Notifications
                        </label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" 
                               id="pushNotifications" 
                               name="pushNotifications"
                               class="form-check-input"
                               <%= user.notifications?.push ? 'checked' : '' %>>
                        <label class="form-check-label" for="pushNotifications">
                            Push Notifications
                        </label>
                    </div>
                </div>

                <!-- Privacy Settings -->
                <div class="settings-section">
                    <h3>Privacy Settings</h3>
                    <div class="form-check">
                        <input type="checkbox" 
                               id="showEmail" 
                               name="privacySettings[showEmail]"
                               class="form-check-input"
                               <%= user.privacySettings?.showEmail ? 'checked' : '' %>>
                        <label class="form-check-label" for="showEmail">
                            Show email to other users
                        </label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" 
                               id="showPhone" 
                               name="privacySettings[showPhone]"
                               class="form-check-input"
                               <%= user.privacySettings?.showPhone ? 'checked' : '' %>>
                        <label class="form-check-label" for="showPhone">
                            Show phone number to other users
                        </label>
                    </div>
                </div>

                <div class="settings-actions">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-outline-danger" onclick="confirmDeleteAccount()">
                        Delete Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function confirmDeleteAccount() {
    if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        fetch('/dashboard/settings/delete-account', {
            method: 'DELETE',
            credentials: 'same-origin'
        }).then(response => {
            if (response.ok) {
                window.location.href = '/logout';
            } else {
                alert('Error deleting account. Please try again.');
            }
        });
    }
}

// Preview profile image before upload
document.getElementById('profile-upload')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profile-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});
</script> 